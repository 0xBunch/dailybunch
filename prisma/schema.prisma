generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ SOURCES ============

model Source {
  id            String       @id @default(cuid())
  name          String
  type          SourceType
  url           String?      // RSS feed URL or website domain
  emailTrigger  String?      // Domain to match for newsletter emails
  categoryId    String
  subcategoryId String?
  isActive      Boolean      @default(true)
  lastFetchedAt DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  category    Category     @relation(fields: [categoryId], references: [id])
  subcategory Subcategory? @relation(fields: [subcategoryId], references: [id])
  mentions    Mention[]

  @@index([type])
  @@index([isActive])
}

enum SourceType {
  RSS
  NEWSLETTER
}

// ============ CATEGORIES ============

model Category {
  id            String        @id @default(cuid())
  name          String        @unique
  slug          String        @unique
  createdAt     DateTime      @default(now())

  subcategories Subcategory[]
  sources       Source[]
  links         Link[]
}

model Subcategory {
  id         String   @id @default(cuid())
  name       String
  slug       String
  categoryId String
  createdAt  DateTime @default(now())

  category Category @relation(fields: [categoryId], references: [id])
  sources  Source[]
  links    Link[]

  @@unique([categoryId, slug])
}

// ============ LINKS ============

model Link {
  id              String    @id @default(cuid())
  url             String    @unique
  canonicalUrl    String    @unique
  domain          String
  title           String?
  description     String?
  imageUrl        String?
  categoryId      String?
  subcategoryId   String?
  aiSummary       String?
  aiProcessedAt   DateTime?
  firstSeenAt     DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  category    Category?     @relation(fields: [categoryId], references: [id])
  subcategory Subcategory?  @relation(fields: [subcategoryId], references: [id])
  mentions    Mention[]
  entities    LinkEntity[]
  digestItems DigestItem[]

  @@index([domain])
  @@index([firstSeenAt])
  @@index([categoryId])
}

model Mention {
  id        String   @id @default(cuid())
  linkId    String
  sourceId  String
  context   String?  // Surrounding text or title from source
  seenAt    DateTime @default(now())
  createdAt DateTime @default(now())

  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)
  source Source @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([linkId, sourceId])
  @@index([seenAt])
}

// ============ ENTITIES ============

model Entity {
  id        String     @id @default(cuid())
  name      String     @unique
  type      EntityType
  aliases   String[]   @default([])
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  links LinkEntity[]

  @@index([type])
}

enum EntityType {
  PERSON
  ORGANIZATION
  PRODUCT
}

model LinkEntity {
  id        String   @id @default(cuid())
  linkId    String
  entityId  String
  createdAt DateTime @default(now())

  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)
  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([linkId, entityId])
}

// ============ SUGGESTED ENTITIES ============

model SuggestedEntity {
  id         String     @id @default(cuid())
  name       String
  type       EntityType
  reason     String?    // Why the AI suggested this
  linkId     String?    // Link that triggered the suggestion
  isApproved Boolean?   // null = pending, true = approved, false = rejected
  createdAt  DateTime   @default(now())

  @@index([isApproved])
}

// ============ DIGESTS ============

model Digest {
  id          String       @id @default(cuid())
  headline    String
  sentAt      DateTime?
  scheduledAt DateTime?
  status      DigestStatus @default(DRAFT)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  items DigestItem[]

  @@index([status])
  @@index([sentAt])
}

enum DigestStatus {
  DRAFT
  SCHEDULED
  SENT
}

model DigestItem {
  id        String   @id @default(cuid())
  digestId  String
  linkId    String
  note      String?  // Editor's note for this item
  position  Int
  createdAt DateTime @default(now())

  digest Digest @relation(fields: [digestId], references: [id], onDelete: Cascade)
  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@unique([digestId, linkId])
  @@index([position])
}

// ============ SUBSCRIBERS ============

model Subscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  isActive      Boolean  @default(true)
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  createdAt     DateTime @default(now())

  @@index([isActive])
}

// ============ BLACKLIST ============

model BlacklistedDomain {
  id        String   @id @default(cuid())
  domain    String   @unique
  reason    String?
  createdAt DateTime @default(now())
}
