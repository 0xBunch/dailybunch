generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TAXONOMY
// ============================================

model Category {
  id            String        @id @default(cuid())
  name          String        @unique // SPORTS, CULTURE, BUSINESS, AI
  slug          String        @unique
  createdAt     DateTime      @default(now())

  subcategories Subcategory[]
  links         Link[]
  sources       Source[]
}

model Subcategory {
  id         String   @id @default(cuid())
  name       String   // Business, Lifestyle, NIL, etc.
  slug       String
  categoryId String
  createdAt  DateTime @default(now())

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  links      Link[]

  @@unique([categoryId, slug])
  @@index([categoryId])
}

// ============================================
// SOURCES
// ============================================

model Source {
  id            String    @id @default(cuid())
  name          String    // "Morning Brew", "Stratechery"
  type          String    // "newsletter" | "rss"
  url           String?   // RSS feed URL or newsletter domain
  emailTrigger  String?   // Domain to match incoming emails
  categoryId    String?
  active        Boolean   @default(true)
  lastFetchedAt DateTime?
  pollFrequency String    @default("realtime") // "realtime" (15min) | "hourly" | "daily"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Trust & Quality scoring
  trustScore    Int       @default(5)     // 1-10 scale: how much to weight this source's links
  tier          String    @default("TIER_3") // TIER_1 (10), TIER_2 (7), TIER_3 (5), TIER_4 (2)

  // Error tracking
  lastError          String?   // Last fetch error message
  lastErrorAt        DateTime? // When the last error occurred
  consecutiveErrors  Int       @default(0) // Count of consecutive failures

  // Link behavior
  includeOwnLinks    Boolean   @default(false) // false = only scrape external links, true = include source's own articles
  showOnDashboard    Boolean   @default(true)  // false = hide from dashboard trending, still visible on /links
  baseDomain         String?   // Extracted from URL (e.g., "stratechery.com"), used to filter self-links
  internalDomains    String[]  @default([]) // Additional domains to treat as internal (e.g., ["passport.online"])

  category      Category?    @relation(fields: [categoryId], references: [id])
  mentions      Mention[]
  sourceItems   SourceItem[]

  @@index([type])
  @@index([active])
  @@index([categoryId])
  @@index([pollFrequency])
}

// Individual posts/items from RSS feeds or newsletters
model SourceItem {
  id          String    @id @default(cuid())
  sourceId    String
  title       String
  url         String    @unique // The original RSS item link
  pubDate     DateTime?
  description String?
  imageUrl    String?   // og:image from the source article
  linkCount   Int       @default(0) // Number of links extracted from this item
  createdAt   DateTime  @default(now())

  source      Source    @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@index([pubDate])
  @@index([createdAt])
}

// ============================================
// LINKS & MENTIONS
// ============================================

model Link {
  id            String    @id @default(cuid())
  canonicalUrl  String    @unique
  originalUrl   String?   // First URL we saw (before canonicalization)
  domain        String
  title         String?
  description   String?
  imageUrl      String?
  author        String?   // Article author if available
  publishedAt   DateTime? // Article publication date if available

  // Content type detection
  mediaType     String?   // article | video | podcast | newsletter | thread

  // AI-generated fields (Layer 1: Basic enrichment)
  aiSummary     String?
  aiAnalyzedAt  DateTime?

  // AI-generated fields (Layer 2: Cultural analysis - for velocity >= 3)
  culturalWhyNow      String?   @db.Text  // Why this resonates now
  culturalTension     String?   @db.Text  // Underlying debate/stakes
  culturalThread      String?   @db.Text  // Connection to other trends
  culturalPrediction  String?             // growing | peaking | fading
  culturalPredictionReason String? @db.Text
  culturalContrarian  String?   @db.Text  // Angle not being discussed
  culturalAnalyzedAt  DateTime?

  // AI-generated commentary (for link detail pages)
  commentary          String?   @db.Text  // 2-3 sentence contextual insight
  commentaryPersona   String?             // connector | historian | skeptic | scout
  commentaryGeneratedAt DateTime?

  // Embedding for similarity search (stored as JSON array of floats)
  embedding           String?   @db.Text  // JSON array of 384 floats (all-MiniLM-L6-v2)
  embeddingGeneratedAt DateTime?

  // Taxonomy
  categoryId    String?
  subcategoryId String?

  // Processing status tracking
  canonicalStatus   String    @default("success") // success | failed | pending
  canonicalError    String?   // Error message if canonicalization failed
  aiStatus          String    @default("pending") // pending | success | failed | skipped
  aiError           String?   // Error message if AI analysis failed
  aiRetryCount      Int       @default(0) // Number of AI analysis retries
  needsManualReview Boolean   @default(false) // Flag for manual review queue

  // Blocked content (robot pages, paywalls, 404s)
  isBlocked         Boolean   @default(false)
  blockedReason     String?   // robot | paywall | 404 | access_denied

  // Enrichment tracking (multi-tier title extraction)
  enrichmentStatus      String    @default("pending") // pending | processing | success | fallback | failed
  enrichmentRetryCount  Int       @default(0)
  enrichmentLastAttempt DateTime?
  enrichmentError       String?
  enrichmentSource      String?   // mercury | jina | firecrawl | html

  // Fallback title when extraction fails
  fallbackTitle         String?
  fallbackTitleSource   String?   // ai | url_path | domain

  // Timestamps
  firstSeenAt   DateTime  @default(now())
  lastSeenAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  category      Category?    @relation(fields: [categoryId], references: [id])
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id])
  mentions      Mention[]
  entities      LinkEntity[]
  digestItems   DigestItem[]
  weeklyReviewSources WeeklyReviewSource[]
  storyLinks    StoryLink[]

  @@index([domain])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([firstSeenAt])
  @@index([lastSeenAt])
  @@index([aiStatus])
  @@index([needsManualReview])
  @@index([enrichmentStatus])
  @@index([enrichmentLastAttempt])
  @@index([isBlocked])
  @@index([mediaType])
}

model Mention {
  id        String   @id @default(cuid())
  linkId    String
  sourceId  String
  seenAt    DateTime @default(now())
  context   String?  // Surrounding text snippet
  createdAt DateTime @default(now())

  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([linkId, sourceId, seenAt])
  @@index([linkId])
  @@index([sourceId])
  @@index([seenAt])
}

// ============================================
// ENTITIES
// ============================================

model Entity {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String?  // URL-friendly slug (generated from name)
  type      String   // "person" | "organization" | "product"
  aliases   String[] // Alternative names/handles
  active    Boolean  @default(true)
  showInTrending Boolean @default(true) // false = hide from trending section

  // Velocity tracking (computed, updated periodically)
  velocityWeek    Int       @default(0) // Links mentioning this entity in last 7 days
  velocityMonth   Int       @default(0) // Links mentioning this entity in last 30 days
  velocityTrend   String?   // rising | stable | falling
  velocityUpdatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links     LinkEntity[]

  @@index([type])
  @@index([active])
  @@index([slug])
  @@index([velocityWeek])
  @@index([showInTrending])
}

model LinkEntity {
  id        String   @id @default(cuid())
  linkId    String
  entityId  String
  createdAt DateTime @default(now())

  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([linkId, entityId])
  @@index([linkId])
  @@index([entityId])
}

model EntitySuggestion {
  id         String   @id @default(cuid())
  name       String
  type       String   // "person" | "organization" | "product"
  aliases    String[]
  linkId     String?  // Link that triggered this suggestion
  status     String   @default("pending") // "pending" | "approved" | "rejected"
  createdAt  DateTime @default(now())
  reviewedAt DateTime?

  @@index([status])
  @@index([createdAt])
}

// Block certain names from being extracted as entities
model EntityBlocklist {
  id        String   @id @default(cuid())
  name      String   @unique // The name to block (case-insensitive matching)
  reason    String?  // Optional note about why this is blocked
  createdAt DateTime @default(now())

  @@index([name])
}

// ============================================
// STORIES (Link Clustering)
// ============================================

model Story {
  id          String    @id @default(cuid())
  title       String    // AI-generated title for the story cluster
  narrative   String?   @db.Text // What ties these links together
  status      String    @default("active") // active | merged | archived

  // Timestamps
  firstLinkAt DateTime  // When the first link in this story was seen
  lastLinkAt  DateTime  // When the most recent link was added
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  links       StoryLink[]

  @@index([status])
  @@index([firstLinkAt])
  @@index([lastLinkAt])
}

model StoryLink {
  id        String   @id @default(cuid())
  storyId   String
  linkId    String   @unique // A link can only belong to one story
  addedAt   DateTime @default(now())

  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([linkId])
}

// ============================================
// DIGESTS
// ============================================

model Digest {
  id        String       @id @default(cuid())
  headline  String
  status    String       @default("draft") // "draft" | "sent"
  sentAt    DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  items     DigestItem[]

  @@index([status])
  @@index([createdAt])
}

model DigestItem {
  id        String   @id @default(cuid())
  digestId  String
  linkId    String
  position  Int
  note      String?  // Editor's note for this item
  createdAt DateTime @default(now())

  digest    Digest   @relation(fields: [digestId], references: [id], onDelete: Cascade)
  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@unique([digestId, linkId])
  @@index([digestId])
  @@index([linkId])
}

// ============================================
// WEEKLY REVIEW (Harper's Style Digest)
// ============================================

model WeeklyReview {
  id          String    @id @default(cuid())
  weekOf      DateTime  // Start of the week
  content     String    @db.Text // The generated paragraph
  status      String    @default("draft") // draft, edited, published
  byline      String    @default("Weekly Review")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  sources     WeeklyReviewSource[]

  @@index([status])
  @@index([weekOf])
}

model WeeklyReviewSource {
  id             String       @id @default(cuid())
  weeklyReviewId String
  linkId         String
  footnoteNumber Int
  claimText      String?      // The specific claim this source supports
  createdAt      DateTime     @default(now())

  weeklyReview   WeeklyReview @relation(fields: [weeklyReviewId], references: [id], onDelete: Cascade)
  link           Link         @relation(fields: [linkId], references: [id])

  @@unique([weeklyReviewId, linkId])
  @@index([weeklyReviewId])
  @@index([linkId])
}

// ============================================
// BLACKLIST
// ============================================

model Blacklist {
  id        String   @id @default(cuid())
  pattern   String   @unique // Domain or URL pattern to block
  type      String   // "domain" | "url"
  reason    String?
  createdAt DateTime @default(now())

  @@index([type])
}

// ============================================
// URL CANONICALIZATION CACHE
// ============================================

model UrlCache {
  id            String   @id @default(cuid())
  originalUrl   String   @unique // The URL before canonicalization
  canonicalUrl  String   // The resolved canonical URL
  redirectChain String[] // Intermediate URLs in the redirect chain
  resolvedAt    DateTime @default(now())
  expiresAt     DateTime // Cache expiration time

  @@index([canonicalUrl])
  @@index([expiresAt])
}
