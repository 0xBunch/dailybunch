generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TAXONOMY
// ============================================

model Category {
  id            String        @id @default(cuid())
  name          String        @unique // SPORTS, CULTURE, BUSINESS, AI
  slug          String        @unique
  createdAt     DateTime      @default(now())

  subcategories Subcategory[]
  links         Link[]
  sources       Source[]
}

model Subcategory {
  id         String   @id @default(cuid())
  name       String   // Business, Lifestyle, NIL, etc.
  slug       String
  categoryId String
  createdAt  DateTime @default(now())

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  links      Link[]

  @@unique([categoryId, slug])
  @@index([categoryId])
}

// ============================================
// SOURCES
// ============================================

model Source {
  id            String    @id @default(cuid())
  name          String    // "Morning Brew", "Stratechery"
  type          String    // "newsletter" | "rss"
  url           String?   // RSS feed URL or newsletter domain
  emailTrigger  String?   // Domain to match incoming emails
  categoryId    String?
  active        Boolean   @default(true)
  lastFetchedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Error tracking
  lastError          String?   // Last fetch error message
  lastErrorAt        DateTime? // When the last error occurred
  consecutiveErrors  Int       @default(0) // Count of consecutive failures

  // Link behavior
  includeOwnLinks    Boolean   @default(false) // false = only scrape external links, true = include source's own articles
  showOnDashboard    Boolean   @default(true)  // false = hide from dashboard trending, still visible on /links

  category      Category?    @relation(fields: [categoryId], references: [id])
  mentions      Mention[]
  sourceItems   SourceItem[]

  @@index([type])
  @@index([active])
  @@index([categoryId])
}

// Individual posts/items from RSS feeds or newsletters
model SourceItem {
  id          String    @id @default(cuid())
  sourceId    String
  title       String
  url         String    @unique // The original RSS item link
  pubDate     DateTime?
  description String?
  imageUrl    String?   // og:image from the source article
  linkCount   Int       @default(0) // Number of links extracted from this item
  createdAt   DateTime  @default(now())

  source      Source    @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@index([pubDate])
  @@index([createdAt])
}

// ============================================
// LINKS & MENTIONS
// ============================================

model Link {
  id            String    @id @default(cuid())
  canonicalUrl  String    @unique
  originalUrl   String?   // First URL we saw (before canonicalization)
  domain        String
  title         String?
  description   String?
  imageUrl      String?
  author        String?   // Article author if available
  publishedAt   DateTime? // Article publication date if available

  // AI-generated fields
  aiSummary     String?
  aiAnalyzedAt  DateTime?

  // Taxonomy
  categoryId    String?
  subcategoryId String?

  // Processing status tracking
  canonicalStatus   String    @default("success") // success | failed | pending
  canonicalError    String?   // Error message if canonicalization failed
  aiStatus          String    @default("pending") // pending | success | failed | skipped
  aiError           String?   // Error message if AI analysis failed
  aiRetryCount      Int       @default(0) // Number of AI analysis retries
  needsManualReview Boolean   @default(false) // Flag for manual review queue

  // Enrichment tracking (multi-tier title extraction)
  enrichmentStatus      String    @default("pending") // pending | processing | success | fallback | failed
  enrichmentRetryCount  Int       @default(0)
  enrichmentLastAttempt DateTime?
  enrichmentError       String?
  enrichmentSource      String?   // mercury | jina | firecrawl | html

  // Fallback title when extraction fails
  fallbackTitle         String?
  fallbackTitleSource   String?   // ai | url_path | domain

  // Timestamps
  firstSeenAt   DateTime  @default(now())
  lastSeenAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  category      Category?    @relation(fields: [categoryId], references: [id])
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id])
  mentions      Mention[]
  entities      LinkEntity[]
  digestItems   DigestItem[]
  weeklyReviewSources WeeklyReviewSource[]

  @@index([domain])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([firstSeenAt])
  @@index([lastSeenAt])
  @@index([aiStatus])
  @@index([needsManualReview])
  @@index([enrichmentStatus])
  @@index([enrichmentLastAttempt])
}

model Mention {
  id        String   @id @default(cuid())
  linkId    String
  sourceId  String
  seenAt    DateTime @default(now())
  context   String?  // Surrounding text snippet
  createdAt DateTime @default(now())

  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([linkId, sourceId, seenAt])
  @@index([linkId])
  @@index([sourceId])
  @@index([seenAt])
}

// ============================================
// ENTITIES
// ============================================

model Entity {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String   // "person" | "organization" | "product"
  aliases   String[] // Alternative names/handles
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links     LinkEntity[]

  @@index([type])
  @@index([active])
}

model LinkEntity {
  id        String   @id @default(cuid())
  linkId    String
  entityId  String
  createdAt DateTime @default(now())

  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([linkId, entityId])
  @@index([linkId])
  @@index([entityId])
}

model EntitySuggestion {
  id         String   @id @default(cuid())
  name       String
  type       String   // "person" | "organization" | "product"
  aliases    String[]
  linkId     String?  // Link that triggered this suggestion
  status     String   @default("pending") // "pending" | "approved" | "rejected"
  createdAt  DateTime @default(now())
  reviewedAt DateTime?

  @@index([status])
  @@index([createdAt])
}

// ============================================
// DIGESTS
// ============================================

model Digest {
  id        String       @id @default(cuid())
  headline  String
  status    String       @default("draft") // "draft" | "sent"
  sentAt    DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  items     DigestItem[]

  @@index([status])
  @@index([createdAt])
}

model DigestItem {
  id        String   @id @default(cuid())
  digestId  String
  linkId    String
  position  Int
  note      String?  // Editor's note for this item
  createdAt DateTime @default(now())

  digest    Digest   @relation(fields: [digestId], references: [id], onDelete: Cascade)
  link      Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@unique([digestId, linkId])
  @@index([digestId])
  @@index([linkId])
}

// ============================================
// WEEKLY REVIEW (Harper's Style Digest)
// ============================================

model WeeklyReview {
  id          String    @id @default(cuid())
  weekOf      DateTime  // Start of the week
  content     String    @db.Text // The generated paragraph
  status      String    @default("draft") // draft, edited, published
  byline      String    @default("Weekly Review")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  sources     WeeklyReviewSource[]

  @@index([status])
  @@index([weekOf])
}

model WeeklyReviewSource {
  id             String       @id @default(cuid())
  weeklyReviewId String
  linkId         String
  footnoteNumber Int
  claimText      String?      // The specific claim this source supports
  createdAt      DateTime     @default(now())

  weeklyReview   WeeklyReview @relation(fields: [weeklyReviewId], references: [id], onDelete: Cascade)
  link           Link         @relation(fields: [linkId], references: [id])

  @@unique([weeklyReviewId, linkId])
  @@index([weeklyReviewId])
  @@index([linkId])
}

// ============================================
// BLACKLIST
// ============================================

model Blacklist {
  id        String   @id @default(cuid())
  pattern   String   @unique // Domain or URL pattern to block
  type      String   // "domain" | "url"
  reason    String?
  createdAt DateTime @default(now())

  @@index([type])
}
